<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Admin</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
    <style>
      .main-content {
        margin-top: 70px;
        margin-left: 250px;
        padding: 20px;
        transition: margin-left 0.3s ease;
      }
      .main-content.expand {
        margin-left: 0;
      }
      .sidebar {
        height: 100%;
        width: 250px;
        position: fixed;
        z-index: 1;
        top: 0;
        left: 0;
        background-color: #0d6efd;
        overflow-x: hidden;
        padding-top: 20px;
        transition: 0.3s;
      }
      .sidebar.closed {
        margin-left: -250px;
      }
      .sidebar a {
        padding: 10px 15px;
        text-decoration: none;
        font-size: 18px;
        color: white;
        display: block;
        transition: 0.3s;
      }
      .sidebar a:hover, .sidebar a.active {
        background-color: #0b5ed7;
        color: white;
      }
      .sidebar-header img {
        width: 80px;
        height: auto;
        margin-bottom: 10px;
      }
      .navbar-custom {
        position: fixed;
        top: 0;
        right: 0;
        left: 250px;
        z-index: 1030;
        padding: 10px 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,.1);
        transition: left 0.3s ease;
      }
      .navbar-custom.expand {
        left: 0;
      }
    </style>
  </head>

  <body>
    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header text-center mb-3">
        <img src="assets/img/logo-eduvote.png" />
        <h6 class="text-white fw-bold">KOMISI PEMILIHAN OSIS</h6>
        <hr class="text-white mx-3" />
      </div>

      <a class="active" href="admin-dashboard.html"
        ><i class="bi bi-speedometer2"></i> Beranda</a
      >
      <a href="data-pemilih.html"><i class="bi bi-people"></i> Data Pemilih</a>
      <a href="kandidat.html"><i class="bi bi-person-badge"></i> Kandidat</a>
      <a href="hasil-suara.html"><i class="bi bi-bar-chart"></i> Hasil Suara</a>
    </div>

    <!-- NAVBAR -->
    <nav class="navbar navbar-light bg-white navbar-custom" id="navbar">
      <div class="d-flex align-items-center">
        <i
          class="bi bi-list fs-3 me-3"
          style="cursor: pointer"
          onclick="toggleSidebar()"></i>
        <span class="fs-5">Dashboard Admin</span>
      </div>
      <div class="ms-auto d-flex align-items-center gap-3">
        <span class="fw-bold" id="adminUser">Admin</span>
        <i class="bi bi-person-circle fs-4"></i>
        <i
          class="bi bi-box-arrow-right fs-4 text-danger"
          onclick="logout()"
          style="cursor: pointer"></i>
      </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="main-content" id="main">
      <h3>Dashboard Admin</h3>
      
      <!-- CARD STATISTIK -->
      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <div class="card p-3 shadow-sm">
            <h6>Total Pemilih</h6>
            <h3 id="totalPemilih">0</h3>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3 shadow-sm">
            <h6>Total Suara Masuk</h6>
            <h3 id="totalMasuk">0</h3>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3 shadow-sm">
            <h6>Total Suara Belum Masuk</h6>
            <h3 id="totalBelum">0</h3>
          </div>
        </div>
      </div>

      <!-- INFORMASI KANDIDAT -->
      <div class="card p-3 shadow-sm mb-4">
        <h5 class="fw-semibold mb-2">Informasi Kandidat</h5>
        <div id="dataKandidat">Memuat...</div>
      </div>

      <!-- GRAFIK SUARA -->
      <div class="card p-3 shadow-sm mb-4">
        <h5>Grafik Suara Realtime</h5>
        <canvas id="chartSuara" height="130"></canvas>
      </div>

      <!-- WAKTU PELAKSANAAN -->
      <div class="card p-3 shadow-sm">
        <h5>Waktu Pelaksanaan</h5>
        <h4 id="waktuRealtime">00:00:00</h4>
      </div>
    </div>

    <!-- SCRIPT -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // ============================
      // SIDEBAR & NAVBAR
      // ============================
      const sidebar = document.getElementById("sidebar");
      const navbar = document.getElementById("navbar");
      const main = document.getElementById("main");

      function toggleSidebar() {
        sidebar.classList.toggle("closed");
        navbar.classList.toggle("expand");
        main.classList.toggle("expand");
      }

      function logout() {
        localStorage.removeItem("admin_login");
        location.href = "admin-login.html";
      }

      let chartSuara;

      // ============================
      // INIT APP
      // ============================
      document.addEventListener("DOMContentLoaded", () => {
        loadTotalPemilih();
        loadSuaraMasuk();
        loadKandidat();
        loadChart();
        loadWaktu();
        
        // Auto refresh setiap 3 detik
        setInterval(() => {
          loadSuaraMasuk();
          loadChart();
        }, 3000);
      });

      // ============================
      // STATISTIK PEMILIH & SUARA - DIPERBAIKI
      // ============================
      function loadTotalPemilih() {
        const pemilih = JSON.parse(localStorage.getItem("pemilih")) || [];
        document.getElementById("totalPemilih").innerText = pemilih.length;
      }

      function loadSuaraMasuk() {
        const pemilih = JSON.parse(localStorage.getItem("pemilih")) || [];
        let suara = JSON.parse(localStorage.getItem("suaraMasuk")) || [];

        // Filter suara dari pemilih yang valid
        const nisPemilihValid = pemilih.map(p => p.nis);
        const suaraValid = suara.filter(s => nisPemilihValid.includes(s.nis));

        const totalMasuk = suaraValid.length;
        const totalBelum = pemilih.length - totalMasuk;

        document.getElementById("totalMasuk").innerText = totalMasuk;
        document.getElementById("totalBelum").innerText = totalBelum;
        
        return suaraValid;
      }

      // ============================
      // DATA KANDIDAT
      // ============================
      function loadKandidat() {
        const kandidat = JSON.parse(localStorage.getItem("kandidat")) || [];
        const box = document.getElementById("dataKandidat");

        if (kandidat.length === 0) {
          box.innerHTML = "<p class='text-muted'>Belum ada kandidat.</p>";
          return;
        }

        box.innerHTML = kandidat
          .map(
            (k) => `
          <div class="p-2 border rounded mb-2">
            <strong>${k.nama}</strong><br>
            Visi: ${k.visi}<br>
            Misi: ${k.misi}
          </div>
        `
          )
          .join("");
      }

      // ============================
      // GRAFIK SUARA - DIPERBAIKI
      // ============================
      function loadChart() {
        const kandidat = JSON.parse(localStorage.getItem("kandidat")) || [];
        const suara = JSON.parse(localStorage.getItem("suaraMasuk")) || [];
        
        // Hitung suara per kandidat
        const hasil = kandidat.map(k => {
          return suara.filter(s => s.idKandidat === k.id).length;
        });

        const ctx = document.getElementById("chartSuara");
        if (!ctx) return;
        
        if (chartSuara) chartSuara.destroy();

        chartSuara = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: kandidat.map(k => k.nama),
            datasets: [{
              label: 'Jumlah Suara',
              data: hasil,
              backgroundColor: [
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 206, 86, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)'
              ],
              borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            }
          }
        });
      }

      // ============================
      // WAKTU REALTIME
      // ============================
      function loadWaktu() {
        setInterval(() => {
          const now = new Date();
          const waktu =
            now.getHours().toString().padStart(2, "0") +
            ":" +
            now.getMinutes().toString().padStart(2, "0") +
            ":" +
            now.getSeconds().toString().padStart(2, "0");
          document.getElementById("waktuRealtime").innerText = waktu;
        }, 1000);
      }
    </script>
  </body>
</html>
