<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hasil Suara</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
    <style>
      .main-content { margin-top: 70px; margin-left: 250px; padding: 20px; transition: 0.3s; }
      .main-content.expand { margin-left: 0; }
      .foto-kandidat { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; }
      
      /* Sidebar */
      .sidebar { height: 100%; width: 250px; position: fixed; background-color: #0d6efd; padding-top: 20px; }
      .sidebar.closed { margin-left: -250px; }
      .sidebar a { padding: 10px 15px; color: white; display: block; }
      .sidebar a.active { background-color: #0b5ed7; }
      
      /* Navbar */
      .navbar-custom { position: fixed; top: 0; right: 0; left: 250px; padding: 10px 20px; }
      .navbar-custom.expand { left: 0; }
    </style>
</head>
<body>
    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header text-center mb-3">
            <img src="assets/img/logo-eduvote.png" />
            <h6 class="text-white fw-bold">KOMISI PEMILIHAN OSIS</h6>
            <hr class="text-white mx-3" />
        </div>
        <a href="admin-dashboard.html"><i class="bi bi-speedometer2"></i> Beranda</a>
        <a href="data-pemilih.html"><i class="bi bi-people"></i> Data Pemilih</a>
        <a href="kandidat.html"><i class="bi bi-person-badge"></i> Kandidat</a>
        <a class="active" href="#"><i class="bi bi-bar-chart"></i> Hasil Suara</a>
    </div>

    <!-- NAVBAR -->
    <nav class="navbar navbar-light bg-white navbar-custom" id="navbar">
        <div class="d-flex align-items-center">
            <i class="bi bi-list fs-3 me-3" style="cursor: pointer" onclick="toggleSidebar()"></i>
            <span class="fs-5">Hasil Suara</span>
        </div>
        <div class="ms-auto d-flex align-items-center gap-3">
            <span class="fw-bold">Admin</span>
            <i class="bi bi-person-circle fs-4"></i>
            <i class="bi bi-box-arrow-right fs-4 text-danger" onclick="logout()" style="cursor: pointer"></i>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="main-content" id="main">
        <h4 class="mb-3">Hasil Perolehan Suara</h4>

        <!-- INFO STATS -->
        <div class="alert alert-info mb-3">
            <strong>Statistik:</strong> 
            Total Suara: <span id="totalSuara">0</span> | 
            Total Pemilih: <span id="totalPemilih">0</span> | 
            <button class="btn btn-sm btn-warning ms-2" onclick="forceRefresh()">Refresh Data</button>
            <button class="btn btn-sm btn-danger ms-2" onclick="createTestData()">Buat Data Testing</button>
        </div>

        <!-- TABLE HASIL -->
        <div class="card mb-4">
            <div class="card-body">
                <table class="table table-striped align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>No</th>
                            <th>Foto</th>
                            <th>Nama</th>
                            <th>Kelas</th>
                            <th>Suara</th>
                        </tr>
                    </thead>
                    <tbody id="tabelHasil">
                        <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- GRAFIK -->
        <div class="card">
            <div class="card-body">
                <h5>Grafik Perolehan Suara</h5>
                <canvas id="chartSuara" height="130"></canvas>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let chartInstance = null;
        
        function toggleSidebar() {
            document.getElementById("sidebar").classList.toggle("closed");
            document.getElementById("navbar").classList.toggle("expand");
            document.getElementById("main").classList.toggle("expand");
        }

        function logout() {
            localStorage.removeItem("admin_login");
            location.href = "admin-login.html";
        }
        
        // Fungsi untuk debug
        function debugConsole() {
            console.clear();
            console.log("=== DEBUG LOCALSTORAGE ===");
            
            const kandidat = JSON.parse(localStorage.getItem("kandidat")) || [];
            const suara = JSON.parse(localStorage.getItem("suaraMasuk")) || [];
            const pemilih = JSON.parse(localStorage.getItem("pemilih")) || [];
            
            console.log("KANDIDAT:", kandidat);
            console.log("SUARA:", suara);
            console.log("PEMILIH:", pemilih);
            
            console.log("\n=== HITUNG SUARA ===");
            kandidat.forEach(k => {
                // Coba beberapa kemungkinan field
                let count1 = suara.filter(s => s.idKandidat === k.id).length;
                let count2 = suara.filter(s => s.id === k.id).length;
                let count3 = suara.filter(s => s.namaKandidat === k.nama).length;
                
                console.log(`${k.nama} (ID: ${k.id}):`);
                console.log(`  - idKandidat match: ${count1}`);
                console.log(`  - id match: ${count2}`);
                console.log(`  - nama match: ${count3}`);
                
                // Cek semua data suara untuk kandidat ini
                suara.forEach((s, idx) => {
                    if (s.idKandidat === k.id || s.id === k.id || s.namaKandidat === k.nama) {
                        console.log(`    Suara ${idx}:`, s);
                    }
                });
            });
            
            alert("Lihat console (F12) untuk debug!");
        }
        
        // Buat data testing jika kosong
        function createTestData() {
            console.log("Membuat data testing...");
            
            // Data kandidat
            const kandidat = [
                { id: "k001", nama: "Nana", kelas: "XI", foto: "", visi: "Visi Nana", misi: "Misi Nana" },
                { id: "k002", nama: "Pratama", kelas: "XI", foto: "", visi: "Visi Pratama", misi: "Misi Pratama" },
                { id: "k003", nama: "dara", kelas: "XI", foto: "", visi: "Visi Dara", misi: "Misi Dara" }
            ];
            localStorage.setItem("kandidat", JSON.stringify(kandidat));
            
            // Data suara (4 orang voting)
            const suara = [
                { nis: "12345", idKandidat: "k001", waktu: new Date().toISOString() },
                { nis: "67890", idKandidat: "k002", waktu: new Date().toISOString() },
                { nis: "54321", idKandidat: "k001", waktu: new Date().toISOString() },
                { nis: "98765", idKandidat: "k003", waktu: new Date().toISOString() }
            ];
            localStorage.setItem("suaraMasuk", JSON.stringify(suara));
            
            // Data pemilih
            const pemilih = [
                { id: "1", nis: "12345", nama: "Pemilih 1" },
                { id: "2", nis: "67890", nama: "Pemilih 2" },
                { id: "3", nis: "54321", nama: "Pemilih 3" },
                { id: "4", nis: "98765", nama: "Pemilih 4" },
                { id: "5", nis: "11111", nama: "Pemilih 5" }
            ];
            localStorage.setItem("pemilih", JSON.stringify(pemilih));
            
            alert("Data testing berhasil dibuat! Refresh halaman.");
            location.reload();
        }
        
        function forceRefresh() {
            loadHasil();
        }

        // LOAD DATA HASIL - VERSI YANG PASTI BEKERJA
        function loadHasil() {
            console.log("Memuat data hasil...");
            
            // Ambil data dengan beberapa kemungkinan format
            const kandidat = JSON.parse(localStorage.getItem("kandidat")) || [];
            let suara = JSON.parse(localStorage.getItem("suaraMasuk")) || [];
            const pemilih = JSON.parse(localStorage.getItem("pemilih")) || [];
            
            console.log("Data kandidat:", kandidat.length);
            console.log("Data suara:", suara);
            console.log("Data pemilih:", pemilih.length);
            
            // Update statistik
            document.getElementById("totalSuara").textContent = suara.length;
            document.getElementById("totalPemilih").textContent = pemilih.length;
            
            let tbody = document.getElementById("tabelHasil");
            
            if (kandidat.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">Belum ada data kandidat</td></tr>';
                return;
            }
            
            // GENERATE TABEL
            let html = '';
            
            for (let i = 0; i < kandidat.length; i++) {
                const k = kandidat[i];
                
                // CARI SUARA DENGAN BEBERAPA KEMUNGKINAN FIELD
                let jumlahSuara = 0;
                
                if (Array.isArray(suara)) {
                    // Coba semua kemungkinan field
                    jumlahSuara = suara.filter(item => {
                        return (
                            (item.idKandidat && item.idKandidat === k.id) ||
                            (item.id && item.id === k.id) ||
                            (item.kandidatId && item.kandidatId === k.id) ||
                            (item.namaKandidat && item.namaKandidat === k.nama)
                        );
                    }).length;
                }
                
                console.log(`${k.nama}: ${jumlahSuara} suara`);
                
                html += `
                <tr>
                    <td>${i + 1}</td>
                    <td><img src="${k.foto || 'assets/img/default-logo.png'}" 
                           class="foto-kandidat" 
                           onerror="this.src='assets/img/default-logo.png'"></td>
                    <td>${k.nama}</td>
                    <td>${k.kelas || 'XI'}</td>
                    <td><span class="badge bg-primary fs-6">${jumlahSuara}</span></td>
                </tr>
                `;
            }
            
            tbody.innerHTML = html;
            
            // BUAT CHART
            buatChart(kandidat, suara);
        }

        // BUAT CHART
        function buatChart(kandidat, suara) {
            const ctx = document.getElementById('chartSuara');
            if (!ctx) return;
            
            // Hancurkan chart lama
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            // Siapkan data
            const labels = kandidat.map(k => k.nama);
            const data = kandidat.map(k => {
                if (!Array.isArray(suara)) return 0;
                return suara.filter(item => {
                    return (
                        (item.idKandidat && item.idKandidat === k.id) ||
                        (item.id && item.id === k.id) ||
                        (item.kandidatId && item.kandidatId === k.id) ||
                        (item.namaKandidat && item.namaKandidat === k.nama)
                    );
                }).length;
            });
            
            console.log("Chart data - Labels:", labels);
            console.log("Chart data - Values:", data);
            
            // Buat chart
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Jumlah Suara',
                        data: data,
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                        borderColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Load saat halaman dibuka
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Halaman Hasil Suara loaded");
            
            // Tambahkan tombol debug
            const debugBtn = document.createElement('button');
            debugBtn.className = 'btn btn-sm btn-secondary position-fixed';
            debugBtn.style.bottom = '70px';
            debugBtn.style.right = '20px';
            debugBtn.style.zIndex = '9999';
            debugBtn.innerHTML = '<i class="bi bi-terminal"></i> Debug Console';
            debugBtn.onclick = debugConsole;
            document.body.appendChild(debugBtn);
            
            // Load data pertama kali
            loadHasil();
            
            // Auto refresh setiap 5 detik
            setInterval(loadHasil, 5000);
            
            // Cek jika data kosong
            const suara = JSON.parse(localStorage.getItem("suaraMasuk")) || [];
            if (suara.length === 0) {
                console.warn("TIDAK ADA DATA SUARA!");
                console.log("Klik tombol 'Buat Data Testing' untuk testing");
            }
        });
    </script>
</body>
</html>
