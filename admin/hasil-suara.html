<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hasil Suara</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
    <style>
      /* Sidebar */
      .sidebar {
        height: 100%;
        width: 250px;
        position: fixed;
        z-index: 1;
        top: 0;
        left: 0;
        background-color: #0d6efd;
        overflow-x: hidden;
        padding-top: 20px;
        transition: 0.3s;
      }
      .sidebar.closed {
        margin-left: -250px;
      }
      .sidebar a {
        padding: 10px 15px;
        text-decoration: none;
        font-size: 18px;
        color: white;
        display: block;
        transition: 0.3s;
      }
      .sidebar a:hover, .sidebar a.active {
        background-color: #0b5ed7;
        color: white;
      }
      .sidebar-header img {
        width: 80px;
        height: auto;
        margin-bottom: 10px;
      }
      
      /* Navbar */
      .navbar-custom {
        position: fixed;
        top: 0;
        right: 0;
        left: 250px;
        z-index: 1030;
        padding: 10px 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,.1);
        transition: left 0.3s ease;
      }
      .navbar-custom.expand {
        left: 0;
      }
      
      /* Main Content */
      .main-content {
        margin-top: 70px;
        margin-left: 250px;
        padding: 20px;
        transition: 0.3s;
      }
      .main-content.expand {
        margin-left: 0;
      }

      .foto-kandidat {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 8px;
      }
      
      /* Chart colors */
      .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
      }
    </style>
  </head>

  <body>
    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header text-center mb-3">
        <img src="assets/img/logo-eduvote.png" />
        <h6 class="text-white fw-bold">KOMISI PEMILIHAN OSIS</h6>
        <hr class="text-white mx-3" />
      </div>

      <a href="admin-dashboard.html"
        ><i class="bi bi-speedometer2"></i> Beranda</a
      >
      <a href="data-pemilih.html"><i class="bi bi-people"></i> Data Pemilih</a>
      <a href="kandidat.html"><i class="bi bi-person-badge"></i> Kandidat</a>
      <a class="active" href="#"><i class="bi bi-bar-chart"></i> Hasil Suara</a>
    </div>

    <!-- NAVBAR -->
    <nav class="navbar navbar-light bg-white navbar-custom" id="navbar">
      <div class="d-flex align-items-center">
        <i
          class="bi bi-list fs-3 me-3"
          style="cursor: pointer"
          onclick="toggleSidebar()"></i>
        <span class="fs-5">Hasil Suara</span>
      </div>

      <div class="ms-auto d-flex align-items-center gap-3">
        <span class="fw-bold">Admin</span>
        <i class="bi bi-person-circle fs-4"></i>
        <i
          class="bi bi-box-arrow-right fs-4 text-danger"
          onclick="logout()"
          style="cursor: pointer"></i>
      </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="main-content" id="main">
      <h4 class="mb-3">Hasil Perolehan Suara</h4>
      
      <!-- STATISTIK CEPAT -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card p-3 shadow-sm">
            <h6>Total Pemilih</h6>
            <h3 id="totalPemilih">0</h3>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3 shadow-sm">
            <h6>Total Suara Masuk</h6>
            <h3 id="totalSuara">0</h3>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3 shadow-sm">
            <h6>Persentase Partisipasi</h6>
            <h3 id="persentase">0%</h3>
          </div>
        </div>
      </div>

      <!-- TABLE HASIL -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead class="table-dark">
                <tr>
                  <th>No</th>
                  <th>Foto</th>
                  <th>Nama Kandidat</th>
                  <th>Visi</th>
                  <th>Jumlah Suara</th>
                  <th>Persentase</th>
                </tr>
              </thead>
              <tbody id="tabelHasil">
                <tr><td colspan="6" class="text-center">Memuat data...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- GRAFIK CHART -->
      <div class="card">
        <div class="card-body">
          <h5>Grafik Perolehan Suara</h5>
          <div class="chart-container">
            <canvas id="chartSuara"></canvas>
          </div>
        </div>
      </div>
      
      <!-- INFO DEBUG -->
      <div class="card mt-4">
        <div class="card-body">
          <h6>Informasi Debug</h6>
          <button class="btn btn-sm btn-secondary" onclick="debugData()">
            Tampilkan Data Debug
          </button>
          <div id="debugInfo" class="mt-2 small text-muted"></div>
        </div>
      </div>
    </div>

    <!-- SCRIPT -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      // Variabel global untuk chart
      let chartInstance = null;
      
      const sidebar = document.getElementById("sidebar");
      const navbar = document.getElementById("navbar");
      const main = document.getElementById("main");

      function toggleSidebar() {
        sidebar.classList.toggle("closed");
        navbar.classList.toggle("expand");
        main.classList.toggle("expand");
      }

      function logout() {
        localStorage.removeItem("admin_login");
        location.href = "admin-login.html";
      }
      
      // Fungsi debug
      function debugData() {
        const kandidat = JSON.parse(localStorage.getItem("kandidat")) || [];
        const suara = JSON.parse(localStorage.getItem("suaraMasuk")) || [];
        const pemilih = JSON.parse(localStorage.getItem("pemilih")) || [];
        
        let info = `
          <strong>Data Debug:</strong><br>
          Jumlah Kandidat: ${kandidat.length}<br>
          Jumlah Suara Masuk: ${suara.length}<br>
          Jumlah Pemilih: ${pemilih.length}<br>
          <br><strong>Detail Suara:</strong><br>
        `;
        
        suara.forEach((s, i) => {
          info += `${i+1}. NIS: ${s.nis}, Kandidat ID: ${s.idKandidat}<br>`;
        });
        
        document.getElementById("debugInfo").innerHTML = info;
        console.log("Kandidat:", kandidat);
        console.log("Suara:", suara);
      }

      // LOAD DATA HASIL - DIPERBAIKI
      function loadHasil() {
        let kandidat = JSON.parse(localStorage.getItem("kandidat")) || [];
        let suara = JSON.parse(localStorage.getItem("suaraMasuk")) || [];
        let pemilih = JSON.parse(localStorage.getItem("pemilih")) || [];
        
        // Update statistik
        document.getElementById("totalPemilih").innerText = pemilih.length;
        document.getElementById("totalSuara").innerText = suara.length;
        
        // Hitung persentase
        const persentase = pemilih.length > 0 
          ? Math.round((suara.length / pemilih.length) * 100) 
          : 0;
        document.getElementById("persentase").innerText = persentase + "%";
        
        let tbody = document.getElementById("tabelHasil");
        
        if (kandidat.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="text-center text-muted">
                Belum ada data kandidat
              </td>
            </tr>
          `;
          buatChart([], []);
          return;
        }
        
        // Hitung total suara untuk chart
        const totalSemuaSuara = suara.length;
        
        // Generate baris tabel
        let rows = '';
        
        kandidat.forEach((k, i) => {
          // Hitung suara untuk kandidat ini berdasarkan idKandidat
          const jumlahSuara = suara.filter(s => s.idKandidat === k.id).length;
          
          // Hitung persentase
          const persentaseSuara = totalSemuaSuara > 0 
            ? ((jumlahSuara / totalSemuaSuara) * 100).toFixed(1) 
            : 0;
          
          rows += `
            <tr>
              <td>${i + 1}</td>
              <td>
                <img src="${k.foto || 'assets/img/default-logo.png'}" 
                     class="foto-kandidat" 
                     alt="${k.nama}"
                     onerror="this.src='assets/img/default-logo.png'">
              </td>
              <td><strong>${k.nama}</strong></td>
              <td>${k.visi || '-'}</td>
              <td>
                <span class="fw-bold text-primary">${jumlahSuara}</span> suara
              </td>
              <td>
                <span class="badge bg-info">${persentaseSuara}%</span>
              </td>
            </tr>
          `;
        });
        
        tbody.innerHTML = rows;
        
        // Buat chart
        buatChart(kandidat, suara);
        
        // Auto-refresh setiap 5 detik
        setTimeout(loadHasil, 5000);
      }

      // GRAFIK - DIPERBAIKI
      function buatChart(kandidat, suara) {
        let ctx = document.getElementById("chartSuara");
        
        if (!ctx) return;
        
        // Hancurkan chart lama jika ada
        if (chartInstance) {
          chartInstance.destroy();
        }
        
        // Siapkan data untuk chart
        let labels = kandidat.map((k) => k.nama);
        let data = kandidat.map((k) => {
          return suara.filter(s => s.idKandidat === k.id).length;
        });
        
        // Warna untuk chart
        const backgroundColors = [
          'rgba(255, 99, 132, 0.6)',
          'rgba(54, 162, 235, 0.6)',
          'rgba(255, 206, 86, 0.6)',
          'rgba(75, 192, 192, 0.6)',
          'rgba(153, 102, 255, 0.6)',
          'rgba(255, 159, 64, 0.6)'
        ];
        
        const borderColors = [
          'rgba(255, 99, 132, 1)',
          'rgba(54, 162, 235, 1)',
          'rgba(255, 206, 86, 1)',
          'rgba(75, 192, 192, 1)',
          'rgba(153, 102, 255, 1)',
          'rgba(255, 159, 64, 1)'
        ];
        
        // Buat chart baru
        chartInstance = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Jumlah Suara",
                data: data,
                backgroundColor: backgroundColors.slice(0, kandidat.length),
                borderColor: borderColors.slice(0, kandidat.length),
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { 
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            },
            plugins: {
              legend: {
                display: true,
                position: 'top'
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const total = data.reduce((a, b) => a + b, 0);
                    const value = context.raw;
                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                    return `Suara: ${value} (${percentage}%)`;
                  }
                }
              }
            }
          }
        });
      }

      // Load data saat halaman dibuka
      document.addEventListener('DOMContentLoaded', function() {
        loadHasil();
        
        // Cek jika ada data
        const suara = JSON.parse(localStorage.getItem("suaraMasuk")) || [];
        console.log("Total suara yang tersimpan:", suara.length);
        
        if (suara.length === 0) {
          console.log("INFO: Belum ada suara yang masuk. Silakan login sebagai pemilih dan berikan suara.");
        }
      });
      
      // Jika halaman di GitHub Pages, mungkin perlu handle CORS/localStorage
      function checkEnvironment() {
        if (window.location.hostname.includes('github.io')) {
          console.log("Running on GitHub Pages");
          // Untuk testing di GitHub Pages, buat sample data jika kosong
          if (!localStorage.getItem("kandidat")) {
            const sampleKandidat = [
              { id: "k001", nama: "Kandidat A", visi: "OSIS aktif", misi: "Meningkatkan kegiatan" },
              { id: "k002", nama: "Kandidat B", visi: "Sekolah kreatif", misi: "Inovasi pembelajaran" }
            ];
            localStorage.setItem("kandidat", JSON.stringify(sampleKandidat));
            
            const sampleSuara = [
              { nis: "12345", idKandidat: "k001", waktu: new Date().toISOString() },
              { nis: "67890", idKandidat: "k002", waktu: new Date().toISOString() }
            ];
            localStorage.setItem("suaraMasuk", JSON.stringify(sampleSuara));
            
            console.log("Sample data dibuat untuk testing");
          }
        }
      }
      
      // Jalankan environment check
      checkEnvironment();
    </script>
  </body>
</html>
