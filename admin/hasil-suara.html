<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hasil Suara</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
    <link rel="stylesheet" href="assets/css/style.css" />
    <style>
      /* Main Content */
      .main-content {
        margin-top: 70px;
        margin-left: 250px;
        padding: 20px;
        transition: 0.3s;
      }
      .main-content.expand {
        margin-left: 0;
      }

      .foto-kandidat {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 8px;
      }
    </style>
  </head>

  <body>
    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header text-center mb-3">
        <img src="assets/img/logo-eduvote.png" />
        <h6 class="text-white fw-bold">KOMISI PEMILIHAN OSIS</h6>
        <hr class="text-white mx-3" />
      </div>

      <a href="admin-dashboard.html"
        ><i class="bi bi-speedometer2"></i> Beranda</a
      >
      <a href="data-pemilih.html"><i class="bi bi-people"></i> Data Pemilih</a>
      <a href="kandidat.html"><i class="bi bi-person-badge"></i> Kandidat</a>
      <a class="active" href="#"><i class="bi bi-bar-chart"></i> Hasil Suara</a>
    </div>

    <!-- NAVBAR -->
    <nav class="navbar navbar-light bg-white navbar-custom" id="navbar">
      <div class="d-flex align-items-center">
        <i
          class="bi bi-list fs-3 me-3"
          style="cursor: pointer"
          onclick="toggleSidebar()"></i>
        <span class="fs-5">Hasil Suara</span>
      </div>

      <div class="ms-auto d-flex align-items-center gap-3">
        <span class="fw-bold">Admin</span>
        <i class="bi bi-person-circle fs-4"></i>
        <i
          class="bi bi-box-arrow-right fs-4 text-danger"
          onclick="logout()"
          style="cursor: pointer"></i>
      </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="main-content" id="main">
      <h4 class="mb-3">Hasil Perolehan Suara</h4>

      <!-- TABLE HASIL -->
      <div class="card mb-4">
        <div class="card-body">
          <table class="table table-striped align-middle">
            <thead class="table-dark">
              <tr>
                <th>No</th>
                <th>Foto</th>
                <th>Nama</th>
                <th>Kelas</th>
                <th>Suara</th>
              </tr>
            </thead>
            <tbody id="tabelHasil"></tbody>
          </table>
        </div>
      </div>

      <!-- GRAFIK CHART -->
      <div class="card">
        <div class="card-body">
          <h5>Grafik Perolehan Suara</h5>
          <canvas id="chartSuara" height="130"></canvas>
        </div>
      </div>
    </div>

    <!-- SCRIPT -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      const sidebar = document.getElementById("sidebar");
      const navbar = document.getElementById("navbar");
      const main = document.getElementById("main");

      function toggleSidebar() {
        sidebar.classList.toggle("closed");
        navbar.classList.toggle("expand");
        main.classList.toggle("expand");
      }

      function logout() {
        localStorage.removeItem("admin_login");
        location.href = "admin-login.html";
      }

      // DEBUG: Fungsi untuk melihat data sebenarnya
      function debugData() {
        const kandidat = JSON.parse(localStorage.getItem("kandidat")) || [];
        const suara = JSON.parse(localStorage.getItem("suaraMasuk")) || [];
        
        console.log("=== DEBUG DATA HASIL SUARA ===");
        console.log("Kandidat:", kandidat);
        console.log("Suara Masuk (format asli):", suara);
        console.log("Jumlah total suara:", suara.length);
        
        // Hitung suara per kandidat
        kandidat.forEach(k => {
          const jumlah = suara.filter(s => s.idKandidat === k.id).length;
          console.log(`${k.nama} (ID: ${k.id}): ${jumlah} suara`);
        });
        
        alert("Lihat console (F12) untuk data debug");
      }

      // LOAD DATA HASIL - DIPERBAIKI
      function loadHasil() {
        // Ambil data dengan format yang benar
        const kandidat = JSON.parse(localStorage.getItem("kandidat")) || [];
        const suara = JSON.parse(localStorage.getItem("suaraMasuk")) || []; // Ini ARRAY, bukan OBJECT
        
        console.log("Data suara yang diterima:", suara);
        console.log("Tipe data suara:", typeof suara);
        console.log("Is array?", Array.isArray(suara));

        let tbody = document.getElementById("tabelHasil");
        tbody.innerHTML = "";

        // Hitung suara untuk setiap kandidat
        kandidat.forEach((k, i) => {
          // CARA BENAR: Hitung berapa banyak suara yang punya idKandidat sama dengan id kandidat
          const totalSuara = suara.filter(item => item.idKandidat === k.id).length;
          
          console.log(`${k.nama}: ${totalSuara} suara (mencari idKandidat: ${k.id})`);

          tbody.innerHTML += `
            <tr>
              <td>${i + 1}</td>
              <td><img src="${k.foto || 'assets/img/default-logo.png'}" class="foto-kandidat" 
                   onerror="this.src='assets/img/default-logo.png'"></td>
              <td>${k.nama}</td>
              <td>${k.kelas || 'XI'}</td>
              <td><span class="fw-bold text-primary">${totalSuara}</span></td>
            </tr>
          `;
        });

        // Buat grafik dengan data yang benar
        buatChart(kandidat, suara);
        
        // Auto-refresh setiap 3 detik
        setTimeout(loadHasil, 3000);
      }

      // GRAFIK - DIPERBAIKI
      function buatChart(kandidat, suara) {
        let ctx = document.getElementById("chartSuara");
        
        // Hancurkan chart lama jika ada
        if (window.chartInstance) {
          window.chartInstance.destroy();
        }

        // Siapkan data untuk chart
        let labels = kandidat.map((k) => k.nama);
        let data = kandidat.map((k) => {
          // Hitung suara untuk setiap kandidat
          return suara.filter(item => item.idKandidat === k.id).length;
        });

        console.log("Data untuk chart - Labels:", labels);
        console.log("Data untuk chart - Values:", data);

        // Buat chart baru
        window.chartInstance = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Total Suara",
                data: data,
                backgroundColor: [
                  'rgba(255, 99, 132, 0.7)',
                  'rgba(54, 162, 235, 0.7)',
                  'rgba(255, 206, 86, 0.7)',
                  'rgba(75, 192, 192, 0.7)',
                  'rgba(153, 102, 255, 0.7)'
                ],
                borderColor: [
                  'rgba(255, 99, 132, 1)',
                  'rgba(54, 162, 235, 1)',
                  'rgba(255, 206, 86, 1)',
                  'rgba(75, 192, 192, 1)',
                  'rgba(153, 102, 255, 1)'
                ],
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: { 
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            }
          }
        });
      }

      // Load data saat halaman dibuka
      document.addEventListener('DOMContentLoaded', function() {
        // Tambahkan tombol debug
        const debugBtn = document.createElement('button');
        debugBtn.className = 'btn btn-sm btn-warning position-fixed';
        debugBtn.style.bottom = '20px';
        debugBtn.style.right = '20px';
        debugBtn.style.zIndex = '1000';
        debugBtn.innerHTML = '<i class="bi bi-bug"></i> Debug';
        debugBtn.onclick = debugData;
        document.body.appendChild(debugBtn);
        
        // Load data
        loadHasil();
        
        // Cek data
        const suara = JSON.parse(localStorage.getItem("suaraMasuk")) || [];
        console.log("Total suara di localStorage:", suara.length);
        
        if (suara.length === 0) {
          console.log("INFO: Tidak ada suara di localStorage");
          console.log("Pastikan sudah memilih di dashboard pemilih");
        }
      });
    </script>
  </body>
</html>
