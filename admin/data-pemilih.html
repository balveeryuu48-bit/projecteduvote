<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Pemilih</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
    <link rel="stylesheet" href="assets/css/style.css" />
    <style>
      .main-content {
        margin-top: 70px;
        margin-left: 250px;
        padding: 20px;
        transition: 0.3s ease;
      }
      .main-content.expand {
        margin-left: 0;
      }

      .text-uppercase {
        text-transform: uppercase;
      }
    </style>
  </head>

  <body>
    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header text-center mb-3">
        <img src="assets/img/logo-kpo.png" />
        <h6 class="text-white fw-bold">KOMISI PEMILIHAN OSIS</h6>
        <hr class="text-white mx-3" />
      </div>

      <a href="admin-dashboard.html"
        ><i class="bi bi-speedometer2"></i> Beranda</a
      >
      <a class="active" href="data-pemilih.html"
        ><i class="bi bi-people"></i> Data Pemilih</a
      >
      <a href="kandidat.html"><i class="bi bi-person-badge"></i> Kandidat</a>
      <a href="hasil-suara.html"><i class="bi bi-bar-chart"></i> Hasil Suara</a>
      <a href="pengaturan.html"><i class="bi bi-gear"></i> Pengaturan</a>
    </div>

    <!-- NAVBAR -->
    <nav class="navbar navbar-light bg-white navbar-custom" id="navbar">
      <div class="d-flex align-items-center">
        <i
          class="bi bi-list fs-3 me-3"
          style="cursor: pointer"
          onclick="toggleSidebar()"></i>
        <span class="fs-5">Data Pemilih</span>
      </div>
      <div class="ms-auto d-flex align-items-center gap-3">
        <span class="fw-bold">Admin</span>
        <i class="bi bi-person-circle fs-4"></i>
        <i
          class="bi bi-box-arrow-right fs-4 text-danger"
          onclick="logout()"
          style="cursor: pointer"></i>
      </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="main-content" id="main">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>Daftar Pemilih</h4>
        <button
          class="btn btn-primary"
          data-bs-toggle="modal"
          data-bs-target="#modalTambah">
          <i class="bi bi-plus-circle"></i> Tambah Pemilih
        </button>
      </div>

      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped align-middle" id="tabelPemilih">
              <thead class="table-dark">
                <tr>
                  <th>No</th>
                  <th>Nama</th>
                  <th>NIS</th>
                  <th>JK</th>
                  <th>Kelas</th>
                  <th>Status</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody id="dataPemilih"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL TAMBAH -->
    <div class="modal fade" id="modalTambah">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Tambah Pemilih</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <label>Nama</label>
            <input id="nama" class="form-control mb-2 text-uppercase" />
            <label>NIS</label>
            <input id="nis" class="form-control mb-2" />
            <label>Jenis Kelamin</label>
            <select id="jk" class="form-control mb-2">
              <option value="L">Laki-laki</option>
              <option value="P">Perempuan</option>
            </select>
            <label>Kelas</label>
            <select id="kelas" class="form-control mb-2">
              <option value="VII">VII</option>
              <option value="VIII">VIII</option>
              <option value="IX">IX</option>
            </select>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              Batal
            </button>
            <button class="btn btn-primary" onclick="tambahPemilih()">
              Simpan
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- SCRIPT -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/sidebar-logo.js"></script>
    <script>
      // Sidebar & Navbar
      const sidebar = document.getElementById("sidebar");
      const navbar = document.getElementById("navbar");
      const main = document.getElementById("main");
      const namaInput = document.getElementById("nama");

      namaInput.addEventListener("input", () => {
        namaInput.value = namaInput.value.toUpperCase();
      });

      function toggleSidebar() {
        sidebar.classList.toggle("closed");
        navbar.classList.toggle("expand");
        main.classList.toggle("expand");
      }

      function logout() {
        localStorage.removeItem("admin_login");
        location.href = "admin-login.html";
      }

      // BATASI INPUT NIS HANYA MAKS 10 DIGIT
      document.getElementById("nis").addEventListener("input", function () {
        this.value = this.value.replace(/\D/g, "").slice(0, 10);
      });

      // ======================
      // PEMILIH
      // ======================
      function loadPemilih() {
        let pemilih = JSON.parse(localStorage.getItem("pemilih")) || [];
        let suara = JSON.parse(localStorage.getItem("suaraMasuk")) || [];
        let tbody = document.getElementById("dataPemilih");
        tbody.innerHTML = "";

        pemilih.forEach((p, i) => {
          // update status otomatis
          p.status = suara.some((s) => s.nis === p.nis)
            ? "Sudah Memilih"
            : "Belum Memilih";

          let statusBadge =
            p.status === "Sudah Memilih"
              ? `<span class="badge bg-success">Sudah Voting</span>`
              : `<span class="badge bg-danger">Belum Voting</span>`;

          tbody.innerHTML += `
            <tr>
              <td>${i + 1}</td>
              <td>${p.nama}</td>
              <td>${p.nis}</td>
              <td>${p.jk}</td>
              <td>${p.kelas}</td>
              <td>${statusBadge}</td>
              <td>
                <button class="btn btn-sm btn-danger" onclick="hapusPemilih(${i})">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          `;
        });

        localStorage.setItem("pemilih", JSON.stringify(pemilih));
      }

      function updateTotalPemilih() {
        let pemilih = JSON.parse(localStorage.getItem("pemilih")) || [];
        localStorage.setItem("totalPemilih", pemilih.length);
      }

      function tambahPemilih() {
        let nama = document.getElementById("nama").value;
        let nis = document.getElementById("nis").value;
        let jk = document.getElementById("jk").value;
        let kelas = document.getElementById("kelas").value;

        if (!nama || !nis || !kelas) {
          alert("Lengkapi data!");
          return;
        }

        if (nis.length !== 10) {
          alert("NIS harus tepat 10 digit!");
          return;
        }

        let pemilih = JSON.parse(localStorage.getItem("pemilih")) || [];
        if (pemilih.some((p) => p.nis === nis)) {
          alert("NIS sudah terdaftar!");
          return;
        }

        pemilih.push({ nama, nis, jk, kelas, status: "Belum Memilih" });
        localStorage.setItem("pemilih", JSON.stringify(pemilih));
        updateTotalPemilih();
        loadPemilih();
        alert("Pemilih berhasil ditambahkan!");
        location.reload();
      }

      function hapusPemilih(i) {
        if (!confirm("Yakin hapus data?")) return;
        let pemilih = JSON.parse(localStorage.getItem("pemilih"));
        pemilih.splice(i, 1);
        localStorage.setItem("pemilih", JSON.stringify(pemilih));
        updateTotalPemilih();
        loadPemilih();
      }

      // ======================
      // Sidebar Sekolah
      // ======================
      function loadSidebarSekolah() {
        const data = JSON.parse(localStorage.getItem("profilSekolah")) || {
          nama: "Memuat...",
          logo: "",
        };
        document.getElementById("sidebarNamaSekolah").innerText = data.nama;
      }

      // ======================
      // AUTO UPDATE STATUS SUARA
      // ======================
      setInterval(() => {
        loadPemilih(); // update status setiap 2 detik
      }, 2000);

      // Inisialisasi
      loadPemilih();
      updateTotalPemilih();
      loadSidebarSekolah();
    </script>
  </body>
</html>
